# nodejs内存泄露问题发生的根本原因 



1： [jvm](/java/jvm浅析) 这篇文章是关于java虚拟机的垃圾回收机制的讲解，nodejs的垃圾回收机制和jvm的很相似，原理相同。

2:：当对象保持着引用关系，内存就会持续增长

3：当面临大量数据运算的时候，新生代空间短期内会不够用，导致崩溃。v8只提供老年代的空间限制，新生代并不能设置。

 可能发生的情况 

1. 使用了全局变量集合，但是没有做清理，临时无用的临时数据一直被全局变量引用着。但是使用全局变量对于大量数据运算的时候，是可以重复利用的，这样反而可以减少gc次数，提供性能，但是要小心使用。

2. 使用了闭包，闭包在编程语言中指的是，函数运算的时候，函数将外部变量的作用域引入到了自身内部。这个外部变量不管是不是全局变量，对于这个函数来说就是全局的，一直不会消失，闭包的意思是函数的定义包括了外部变量。

# 代码上出现的场景可能有：

1. 在类中定义了一个函数，这个函数使用了类的变量，这种情况的闭包是很合理的，一般不会出现内存泄露。

2. 在一个函数中，定义了一个函数，或者定义了一个类，在js中类和函数本质上是同一个东西，这个类或者变量使用了函数的变量，这些变量将被闭包成为不会消失的变量，由于这个函数本身就是临时的，所以这种情况很容易出现内存泄露。指的注意的是，创建对象引用并不会出现这个问题，这个问题只对类和对象，属于类型定义。像{}这样只是直接创建，不属于定义类型。

3. promise使用，这个本质上也是2的说明，在使用这个特性的时候，必须要使用闭包，因为他不支持传递参数，这很容易出现内存泄露的闭包。所以如果要使用promise，所使用的变量必须是全局的，而不是局部的。

4. 使用了外部组件库，外部组件对象会渲染到一个div上，此时，就算div消失，这个组件对象也不会消失，因为div的这种获取一旦获取成功，一般不会再次获取，不会报错，如果返回创建多个组件对象，只是对同一个div做了多次覆盖操作。



# 如何定内存泄露 

1. 先判断是不是内存泄露，通过观察，查看是不是当不再运算以后内存会降到符合预期的大小，如果是，那么只是因为计算量太大，临时对象太多。

2. 如果内存一直保持着增长，让程序内存增长一下，然后通过浏览器，或者使用heapdump，打印一下内存快照。

3. 使用内存快照查看工具，浏览器开发者工具，或者devtools等，查看内存快照中存在的对象之间的关系。

4. 预期上，发生了内存持续增长，应该不存在任何没有被引用的变量，变量都是有引用关系的，此时应该查看什么对象最多，定位对象的引用位置。

5. 如果定位到了对象是我们自己定义的类型，这是最好的结果，如果对象只是一些数组和字符串，这个 时候要定位要这些对象被谁引用着，尽量往上追到一个特殊的对象，我们的目的是发现能够标识出代码问题的对象，通过特殊的对象，找到这个对象在代码的位置，分析这些位置出的代码逻辑，检查是否有闭包问题，或者别的问题导致引用一直保持。

6. 这种分析办法适用于任何动态内存语言，Java python也适合